# Fixing Your Current Errors

## Issue 1: Gem Authentication Failing ‚ùå

**Error:**
```
‚ùå Authentication failed after 15s. Page title: "Email Log In"
‚ùå Magic link authentication failed - not logged in after using link
```

**This means:** The popup fix isn't working. The page stays stuck on "Email Log In".

### üîç Debug Steps:

**Option A: Replace with Diagnostic Version**

Replace your `server/gem-scraper.js` with the `diagnostic-gem-scraper.js` I just created. Then run a sync and check the logs. You'll see:

```
üìä PAGE ANALYSIS:
   URL: https://gem.app/emailLogIn?...
   Title: Email Log In
   Has "Logged In" text: true/false
   Has "Continue" text: true/false
   Buttons found: 3
   Button details:
      1. "Continue" (visible: true)
      2. "√ó" (visible: true)
```

This tells us EXACTLY what's on the page and whether our button selector is finding it.

**Option B: Check the Screenshots**

The scraper is saving screenshots to `/tmp/`. Can you access these?
- `/tmp/gem-1-initial.png` - Right after clicking magic link
- `/tmp/gem-2-after-popup.png` - After trying to click Continue
- `/tmp/gem-error-state.png` - Final error state

If you can see these, share them - they'll show exactly what's happening.

**Option C: Possible Root Causes**

Based on the error pattern, here are likely causes:

1. **Magic link expires too fast**
   - Solution: Make the sync process faster
   - Or request a fresh link right before using it

2. **Popup appears but button selector is wrong**
   - The diagnostic version will show you the exact button text
   - We can adjust the selector

3. **Gem detects headless browser**
   - They might block automation entirely
   - We may need to try a different approach

4. **Session/cookie issue**
   - The magic link might need cookies from the request email
   - We might need to use the same browser context

### üí° Alternative Approach: Skip Magic Link Entirely

Instead of:
1. Request login email
2. Extract magic link
3. Open browser
4. Click link
5. Handle popup
6. Scrape items

Try:
1. Log in manually in a regular browser
2. Export cookies
3. Use cookies in scraper (no magic link needed!)

Want me to show you how to do cookie-based authentication?

---

## Issue 2: Azure OpenAI Content Filter ‚ö†Ô∏è

**Error:**
```
‚ùå BadRequestError: 400 The response was filtered due to the prompt triggering Azure OpenAI's content management policy
```

**This means:** Your email extraction AI prompt triggered Azure's content filter. This happens when:
- The email contains blocked words (even innocent ones)
- The prompt itself has language Azure doesn't like
- The response would contain filtered content

### üîß Fix Options:

**Option 1: Add Content Filter Bypass (Safest)**

Update your email extraction code to handle this gracefully:

```javascript
try {
  const completion = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [/* your messages */],
    temperature: 0.1,
  });
  
  const aiResponse = completion.choices[0].message.content.trim();
  // Process response...
  
} catch (error) {
  if (error.message.includes('content management policy')) {
    console.log('‚ö†Ô∏è Content filter triggered - likely a false positive');
    console.log('üìß Email from:', from);
    console.log('üìß Subject:', subject);
    
    // Return gracefully instead of crashing
    return res.status(200).json({ 
      success: false, 
      message: 'Content filter triggered - email skipped',
      reason: 'azure_content_filter'
    });
  }
  
  throw error; // Re-throw other errors
}
```

**Option 2: Sanitize Email Content Before Sending to AI**

```javascript
function sanitizeEmailContent(content) {
  // Remove URLs (they sometimes trigger filters)
  let cleaned = content.replace(/https?:\/\/[^\s]+/g, '[URL]');
  
  // Remove email addresses
  cleaned = cleaned.replace(/[\w.-]+@[\w.-]+\.\w+/g, '[EMAIL]');
  
  // Limit length (shorter = less likely to trigger)
  cleaned = cleaned.substring(0, 3000);
  
  return cleaned;
}

// Use it:
const emailContent = sanitizeEmailContent(req.body.plain || req.body.html);
```

**Option 3: Add Retry Logic**

Sometimes it's just a temporary Azure issue:

```javascript
async function callOpenAIWithRetry(messages, maxRetries = 2) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const completion = await openai.chat.completions.create({
        model: 'gpt-4o-mini',
        messages: messages,
        temperature: 0.1,
      });
      
      return completion;
      
    } catch (error) {
      if (error.message.includes('content management policy')) {
        if (i === maxRetries - 1) {
          throw new Error('Content filter - email cannot be processed');
        }
        
        console.log(`‚ö†Ô∏è Content filter, retry ${i + 1}/${maxRetries}`);
        await new Promise(resolve => setTimeout(resolve, 2000));
      } else {
        throw error;
      }
    }
  }
}
```

**Option 4: Switch to Anthropic API for Email Parsing**

Azure's filter is stricter than Claude's. Use Claude for email parsing:

```javascript
// Instead of OpenAI:
const response = await anthropic.messages.create({
  model: 'claude-sonnet-4-20250514',
  max_tokens: 1000,
  messages: [{
    role: 'user',
    content: `Extract sale info from this email: ${emailContent}`
  }]
});

const aiResponse = response.content[0].text;
```

Claude is less likely to trigger content filters.

---

## üöÄ Quick Action Plan

### For Gem (Priority 1):

1. **Replace your gem-scraper.js** with `diagnostic-gem-scraper.js`
2. **Run a sync** and check the detailed logs
3. **Share the logs** (especially the PAGE ANALYSIS section)
4. **Share screenshots** if you can access `/tmp/` folder

This will tell us exactly why authentication is failing.

### For Azure Content Filter (Priority 2):

1. **Add error handling** (Option 1 above) - prevents crashes
2. **Consider sanitizing content** (Option 2) - reduces false positives
3. **Or switch to Claude API** (Option 4) - more permissive

The content filter is annoying but not critical - it just means some emails get skipped.

---

## ü§î My Hunch on the Gem Issue

Based on the pattern, I think:

1. The magic link loads fine ‚úÖ
2. The "Logged In" popup appears ‚úÖ
3. But clicking "Continue" doesn't actually work ‚ùå

**Why?** Possible reasons:
- Button is there but disabled
- Clicking triggers JavaScript that fails
- Page redirects before we can interact
- Gem changed their authentication flow

**The diagnostic version will tell us which!**

---

## üì¨ Next Steps

1. Run the diagnostic version
2. Share the logs (especially PAGE ANALYSIS)
3. I'll tell you exactly what to fix

Or if you can share your current `gem-scraper.js`, I can directly patch it with the right fix.

Want to try the diagnostic version first?
