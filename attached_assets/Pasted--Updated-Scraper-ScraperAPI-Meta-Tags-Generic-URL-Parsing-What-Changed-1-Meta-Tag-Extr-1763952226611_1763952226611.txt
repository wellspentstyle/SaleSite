# Updated Scraper: ScraperAPI Meta Tags + Generic URL Parsing

## What Changed

### 1. Meta Tag Extraction via ScraperAPI âœ…

**Old approach:** Tried 4 different user-agents directly
**Problem:** All got blocked by DataDome (403 Forbidden)

**New approach:** Use ScraperAPI to bypass bot protection

```javascript
// Now uses ScraperAPI with render: false for speed
await extractMetaTags(url, fetchImpl, logger, scraperApiKey);

// Settings:
// - render: false (no JS, fast)
// - 5-second timeout
// - Fails gracefully (doesn't block whole scrape)
```

**Benefits:**
- âœ… Bypasses DataDome, Cloudflare, etc.
- âœ… Fast (no JS rendering needed for meta tags)
- âœ… One API call per URL
- âœ… Graceful failure (continues without meta tags if it fails)

**Cost:** 
- 1 ScraperAPI call per product
- 200 URLs/day = 6,000 calls/month
- Check your ScraperAPI plan for limits

---

### 2. Generic URL Parsing (No Domain-Specific Code) âœ…

**Priority order:**

#### Priority 1: Query Parameters (NEW!)
Checks these params FIRST:
- `searchText` (Banana Republic, Gap)
- `q` (generic)
- `query` (common)
- `search` (alternative)
- `keyword` (some sites)
- `name`, `title`, `text` (direct names)

**Example:**
```
URL: bananarepublic.gap.com/product.do?searchText=denim+shirt
Extracted: "denim shirt" âœ…
```

#### Priority 2: Product ID from Query Params
Checks: `id`, `productid`, `pid`, `itemid`, `sku`, `productcode`, `ID`

**Example:**
```
URL: ...?pid=825024012
Extracted: "825024012" âœ…
```

#### Priority 3: URL Path Slugs
If nothing in query params, extract from path:
- Takes longest segment with words
- Skips file extensions (`.do`, `.jsp`, `.php`, `.aspx`, `.html`)
- Skips common words (`product`, `browse`, `shop`)
- Converts dashes to spaces

**Example:**
```
URL: /product/proenza-schouler-dress/12345
Extracted: "proenza schouler dress" âœ…
```

**No domain-specific code!** Works generically across all sites.

---

### 3. Improved Google Shopping Queries âœ…

**Query strategies (in order):**

```javascript
// Strategy 1: Meta tags (if available) - EXACT match with quotes
"Proenza Schouler Zion Linen Top" saksfifthavenue.com

// Strategy 2: URL query param (if available) - FUZZY match
denim shirt bananarepublic.gap.com

// Strategy 3: Product ID (if available)
825024012 bananarepublic.gap.com

// Strategy 4: Generic fallback
product saksfifthavenue.com
```

**Improved logging:**
```
ğŸ” [Google Shopping] Strategy 1/4: meta-tags-exact
   Query: "Proenza Schouler..." (exact match)
   
ğŸ” [Google Shopping] Strategy 2/4: url-query-param  
   Query: "denim shirt..." (fuzzy match)
```

---

## Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Input: Product URL                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Extract Meta Tags via ScraperAPI      â”‚
â”‚  â€¢ Uses ScraperAPI (bypasses DataDome)         â”‚
â”‚  â€¢ 5-second timeout                             â”‚
â”‚  â€¢ Gets: og:title, og:image                     â”‚
â”‚  â€¢ If fails â†’ continues (not critical)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Parse URL (Generic Patterns)          â”‚
â”‚  Priority 1: Query params (searchText, q, etc.) â”‚
â”‚  Priority 2: Product ID from params             â”‚
â”‚  Priority 3: Path slugs (longest segment)       â”‚
â”‚  â€¢ Skips .do, .jsp, etc.                        â”‚
â”‚  â€¢ No domain-specific code                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Build Google Shopping Queries         â”‚
â”‚  Query 1: Meta tag name (exact, with quotes)    â”‚
â”‚  Query 2: URL param name (fuzzy, no quotes)     â”‚
â”‚  Query 3: Product ID + domain                   â”‚
â”‚  Query 4: Generic "product" + domain            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: Try Each Query Until Success          â”‚
â”‚  â€¢ Matches domain in results                    â”‚
â”‚  â€¢ Returns: name, brand, image, prices          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                     â”‚
    âœ… Found              âŒ Not Found
         â”‚                     â”‚
         â†“                     â†“
   Return Product      Fallback to Full
      (fast!)          ScraperAPI Scrape
                         (slow backup)
```

---

## Expected Behavior

### Example 1: Banana Republic

**Input:**
```
URL: https://bananarepublic.gap.com/browse/product.do?pid=825024012&searchText=denim%20shirt
```

**Processing:**
```
ğŸ·ï¸  [Meta Tags] Fetching via ScraperAPI...
âš ï¸  [Meta Tags] No og: tags found (OK, continuing)

ğŸ“ Extracted product info:
   Meta tags: none
   URL query params: "denim shirt" âœ…
   Product ID: 825024012 âœ…
   Domain: bananarepublic.gap.com

ğŸ” [Google Shopping] Strategy 1/2: url-query-param
   Query: "denim shirt bananarepublic.gap.com" (fuzzy match)
âœ… Found 15 results
âœ… First result: "Relaxed-Fit Denim Short-Sleeve Shirt"
âœ… Match! Price: $89.50
```

**Result:** âœ… Success in ~3-5 seconds

---

### Example 2: Saks (Meta Tags Available)

**Input:**
```
URL: https://www.saksfifthavenue.com/product/proenza-schouler-zion-top-0400022421822.html
```

**Processing:**
```
ğŸ·ï¸  [Meta Tags] Fetching via ScraperAPI...
âœ… [Meta Tags] Extracted product name: "Proenza Schouler Zion Linen-Blend Top"
âœ… [Meta Tags] Extracted image URL

ğŸ“ Extracted product info:
   Meta tags: "Proenza Schouler Zion Linen-Blend Top" âœ…
   Product ID: 0400022421822 âœ…
   Domain: saksfifthavenue.com

ğŸ” [Google Shopping] Strategy 1/3: meta-tags-exact
   Query: "Proenza Schouler Zion Linen-Blend Top saksfifthavenue.com" (exact match)
âœ… Found 8 results
âœ… Exact domain match from Saks
âœ… Price: $435.00
```

**Result:** âœ… Success in ~4-6 seconds (includes ScraperAPI call)

---

### Example 3: No Query Params, No Meta Tags

**Input:**
```
URL: https://example.com/catalog/blue-cotton-tshirt/prod789012
```

**Processing:**
```
ğŸ·ï¸  [Meta Tags] Fetching via ScraperAPI...
âš ï¸  [Meta Tags] Timeout after 5 seconds, continuing without meta tags

ğŸ“ Extracted product info:
   Meta tags: none
   URL slug: "blue cotton tshirt" âœ…
   Product ID: 789012 âœ…
   Domain: example.com

ğŸ” [Google Shopping] Strategy 1/3: url-query-param
   Query: "blue cotton tshirt example.com" (fuzzy match)
âœ… Found results...
```

**Result:** âœ… Success via URL parsing fallback

---

## Configuration Required

### Environment Variables:

```bash
# Required: Google Shopping API
SERPER_API_KEY=your_serper_key_here

# Required: For meta tag extraction via ScraperAPI
SCRAPER_API_KEY=your_scraper_api_key_here

# Optional: OpenAI (for fallback AI extraction)
OPENAI_API_KEY=your_openai_key_here
```

### In Your Code:

```javascript
import { scrapeProduct } from './fast-scraper-updated.js';

const result = await scrapeProduct(url, {
  openai: openaiClient,
  serperApiKey: process.env.SERPER_API_KEY,
  scraperApiKey: process.env.SCRAPER_API_KEY,  // â† NEW!
  fetchImpl: fetch,
  logger: console
});
```

---

## Cost Breakdown

### Per Product URL:

1. **Meta Tag Extraction:** 1 ScraperAPI call (~$0.001)
2. **Google Shopping:** 1-4 Serper API calls (free tier available)
3. **Fallback Scrape:** 1 additional ScraperAPI call if all fails (~$0.001)

### For 200 URLs/day (6,000/month):

**Best case (meta tags + Google Shopping work):**
- ScraperAPI: 6,000 calls = ~$6/month
- Serper: Free tier (25,000 calls/month)
- **Total: ~$6/month**

**Worst case (all fallback to full scrape):**
- ScraperAPI: 12,000 calls (meta + fallback) = ~$12/month
- Serper: Free tier
- **Total: ~$12/month**

**Check your ScraperAPI pricing!** Rates vary by plan.

---

## What to Test

1. **Banana Republic URL with searchText:**
   ```
   https://bananarepublic.gap.com/browse/product.do?pid=825024012&searchText=denim%20shirt
   ```
   **Expected:** Query param extraction works, Google Shopping finds it

2. **Saks URL (DataDome protected):**
   ```
   https://www.saksfifthavenue.com/product/proenza-schouler-zion-top-0400022421822.html
   ```
   **Expected:** ScraperAPI gets meta tags, exact match in Google Shopping

3. **Generic URL with path slug:**
   ```
   https://nordstrom.com/s/good-american-jeans/7656237
   ```
   **Expected:** Path parsing works, Google Shopping finds it

---

## Differences from Old Code

| Feature | Old Code | New Code |
|---------|----------|----------|
| Meta tag extraction | 4 user-agent attempts (all blocked) | ScraperAPI (bypasses blocks) âœ… |
| URL parsing | Domain-specific patterns | Generic patterns for all sites âœ… |
| Query params | Not checked | Checked FIRST âœ… |
| File extensions | Not filtered | Skipped (.do, .jsp, etc.) âœ… |
| Google Shopping queries | Basic | Multi-strategy with quotes/fuzzy âœ… |
| Logging | Minimal | Detailed (shows sources) âœ… |
| Maintenance | Domain-specific code to update | Generic (works everywhere) âœ… |

---

## Ready to Test!

The updated code is in: `/mnt/user-data/outputs/fast-scraper-updated.js`

**Just add your ScraperAPI key and test it out!**